
<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>„Ç´„Çπ„Çø„É†Â≠¶Áøí-4Taku_v0</title>
    <style>
      body {
          background: #f3f4f6;
          font-family: 'Segoe UI', 'Meiryo', sans-serif;
          margin: 0;
          padding: 0;
      }

      .container {
          position: relative;
          width: 100%;
          max-width: 420px;
          margin: 2rem auto;
          background: #fff;
          border-radius: 16px;
          box-shadow: 0 4px 16px rgba(0,0,0,0.08);
          padding: 2rem 1rem 2rem 1rem;
      }

      .title {
          text-align: center;
          font-size: 2rem;
          font-weight: bold;
          color: #222;
          margin-bottom: 1.5rem;
      }
      
      .flashcard-page-title {
          font-size: 1.1rem;
          font-weight: 600;
          color: #222;
          margin-bottom: 0.5rem;
          text-align: center;
      }
      .flashcard-page-title span {
          color: #4b5563;
          font-weight: 600;
          font-size: 1.1rem;
      }
      
      .problem-number {
          font-size: 1.1rem;
          font-weight: 600;
          color: #4b5563;
          text-align: left;
          margin-bottom: 1rem;
          width: 100%;
          max-width: 400px;
      }

      .list-card {
          background: #f9fafb;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          padding: 1.2rem 1rem;
          margin-bottom: 1.2rem;
      }

      .list-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.7rem;
          border-bottom: 1px solid #e5e7eb;
          padding-bottom: 0.3rem;
          gap: 0.5rem;
      }

      .list-title {
          font-size: 1.2rem;
          font-weight: 600;
          color: #333;
          margin: 0;
          border: none;
          padding: 0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      
      .progress-info {
          font-size: 0.8rem;
          color: #6b7280;
          margin-bottom: 0.7rem;
          text-align: center;
          background: #e5e7eb;
          padding: 0.3rem 0;
          border-radius: 6px;
      }

      .delete-btn {
          background: #6b7280;
          color: white;
          border: none;
          border-radius: 6px;
          padding: 0.3rem 0.8rem;
          font-size: 0.9rem;
          font-weight: 500;
          cursor: pointer;
          transition: background 0.2s;
          flex-shrink: 0;
      }
      .delete-btn:hover {
          background: #4b5563;
      }

      .list-btns {
          display: flex;
          justify-content: space-around;
          gap: 0.5rem;
      }

      .mode-btn {
          width: 48%;
          padding: 0.7rem 0;
          border: none;
          border-radius: 8px;
          font-size: 1rem;
          font-weight: bold;
          color: #fff;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.07);
          transition: background 0.2s;
      }
      .mode-btn.learn { background: #3b82f6; }
      .mode-btn.learn:hover { background: #2563eb; }
      .mode-btn.test { background: #f59e42; }
      .mode-btn.test:hover { background: #ea580c; }

      .add-btn {
          width: 100%;
          max-width: 260px;
          padding: 0.8rem 0;
          background: #22c55e;
          color: #fff;
          font-weight: bold;
          border: none;
          border-radius: 10px;
          font-size: 1.1rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
      }
      .add-btn:hover {
          background: #16a34a;
          transform: scale(1.04);
      }

      .add-btn-secondary {
          width: 100%;
          max-width: 240px;
          padding: 0.7rem 0;
          background: #fef08a;
          color: #1f2937;
          font-weight: bold;
          border: 1px solid #facc15;
          border-radius: 10px;
          font-size: 1rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.06);
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
      }
      .add-btn-secondary:hover {
          background: #fde047;
          transform: scale(1.04);
      }

      .card-container {
          width: 100%;
          max-width: 400px;
          height: 210px;
          perspective: 1000px;
          cursor: pointer;
          margin: 0 auto 1rem auto;
      }

      .card {
          width: 100%;
          height: 100%;
          position: relative;
          transform-style: preserve-3d;
          transition: transform 0.6s;
      }

      .card.is-flipped {
          transform: rotateY(180deg);
      }

      .card-face {
          position: absolute;
          width: 100%;
          height: 100%;
          backface-visibility: hidden;
          display: flex;
          justify-content: flex-start;
          align-items: flex-start;
          border-radius: 15px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          padding: 1.5rem;
          text-align: left;
          word-break: break-word;
          box-sizing: border-box;
      }
      
      .card-front {
          background: #fefce8; /* ËñÑ„ÅÑÈªÑËâ≤ */
          color: #111827;      /* ÈªíÂ≠ó */
          font-size: 1.5rem;
          font-weight: bold;
      }

      .card-back {
          background: #f0f9ff; /* ËñÑ„ÅÑÊ∞¥Ëâ≤ */
          color: #111827;      /* ÈªíÂ≠ó */
          font-size: 1.3rem;
          font-weight: 600;
          transform: rotateY(180deg);
      }

      .done-card .card-front {
          font-size: 2rem;
          color: #15803d; /* ÂÆå‰∫Ü„ÉÜ„Ç≠„Çπ„Éà„ÇíÁ∑ëËâ≤„Å´ */
      }
      
      .done-card .card-face {
          justify-content: center;
          align-items: center;
          text-align: center;
      }

      .counters {
          display: flex;
          justify-content: center;
          margin-bottom: 1rem;
          font-size: 1rem;
          color: #444;
      }

      .counters span {
          margin: 0 1em; /* Add horizontal spacing between counters */
      }
      
      .choices-container {
          display: flex;
          flex-direction: column;
          gap: 0.75rem;
          width: 100%;
          max-width: 400px;
          margin: 0 auto 1rem auto;
          counter-reset: choice-counter; /* CSS„Ç´„Ç¶„É≥„Çø„Éº„ÇíÂàùÊúüÂåñ */
      }

      .choice-btn {
          width: 100%;
          padding: 0.6rem 1rem;
          background: #fff;
          color: #1f2937;
          border: 1px solid #d1d5db;
          border-radius: 12px;
          font-size: 1.1rem;
          font-weight: 500;
          text-align: left;
          cursor: pointer;
          transition: background-color 0.2s, border-color 0.2s, color 0.2s, transform 0.1s;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
          display: flex;
          align-items: center;
          position: relative;
      }

      .choice-btn:hover:not(:disabled) {
          background-color: #f9fafb;
          border-color: #9ca3af;
      }

      .choice-btn:active:not(:disabled) {
          transform: scale(0.98);
      }

      .choice-btn:disabled {
          cursor: not-allowed;
          opacity: 0.9;
      }

      .choice-btn.correct {
          background-color: #dcfce7; /* green-100 */
          border-color: #22c55e;   /* green-500 */
          color: #166534;        /* green-800 */
          font-weight: bold;
      }

      .choice-btn.incorrect {
          background-color: #fee2e2; /* red-100 */
          border-color: #ef4444;   /* red-500 */
          color: #991b1b;        /* red-800 */
          font-weight: bold;
      }
      
      .choice-btn.correct::after, .choice-btn.incorrect::after {
          content: '';
          position: absolute;
          right: 1rem;
          font-size: 1.5rem;
      }

      .choice-btn.correct::after {
          content: '‚úÖ';
      }

      .choice-btn.incorrect::after {
          content: '‚ùå';
      }

      .choice-btn::before {
          content: counter(choice-counter, upper-alpha); /* A, B, C, D... */
          counter-increment: choice-counter;
          font-weight: bold;
          font-size: 1rem;
          color: #4b5563;
          background-color: #e5e7eb;
          border-radius: 50%;
          width: 1.8em;
          height: 1.8em;
          display: inline-flex;
          justify-content: center;
          align-items: center;
          margin-right: 1rem;
          flex-shrink: 0;
      }
      
      .action-buttons-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        width: 100%;
        max-width: 400px;
        margin: 0 auto;
      }

      .sub-btn-row {
          display: flex;
          justify-content: center;
          gap: 1rem;
          width: 100%;
      }

      .sub-btn {
          padding: 0.5rem 1.2rem;
          background-color: #fff;
          color: #1f2937;
          border: 1px solid #d1d5db;
          border-radius: 7px;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          transition: background-color 0.2s, border-color 0.2s;
      }
      .sub-btn:hover {
          background-color: #f3f4f6;
      }
      
      .sub-btn-suspend {
        background-color: #f0fdf4;
        border-color: #a7f3d0;
      }
      .sub-btn-suspend:hover {
          background-color: #dcfce7;
          border-color: #6ee7b7;
      }

      .sub-btn-reset {
          background-color: #fef2f2;
          border-color: #fecaca;
      }
      .sub-btn-reset:hover {
          background-color: #fee2e2;
          border-color: #fca5a5;
      }

      .sub-btn-review {
          background-color: #f0f9ff;
          border-color: #bae6fd;
      }
      .sub-btn-review:hover {
          background-color: #e0f2fe;
          border-color: #7dd3fc;
      }
      
      .next-btn {
          width: 100%;
          padding: 0.8rem 0;
          background: #3b82f6;
          color: #fff;
          font-weight: bold;
          border: none;
          border-radius: 10px;
          font-size: 1.1rem;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          cursor: pointer;
          transition: background 0.2s, transform 0.2s;
      }
      .next-btn:hover {
          background: #2563eb;
      }

      .back-link {
          background: none;
          border: none;
          color: #3b82f6;
          font-size: 1rem;
          cursor: pointer;
          text-decoration: underline;
          margin-top: 1.5rem;
      }
      .back-link:hover {
          color: #1d4ed8;
      }

      .flashcard-page {
          display: flex;
          flex-direction: column;
          align-items: center;
      }
      .mt-8 {
          margin-top: 2rem;
      }
      .text-center {
          text-align: center;
      }

      /* Settings Icon */
      #settingsBtn {
          position: absolute;
          top: 1rem;
          right: 1rem;
          background: none;
          border: none;
          font-size: 1.8rem;
          cursor: pointer;
          color: #6b7280;
          transition: color 0.2s, transform 0.2s;
      }
      #settingsBtn:hover {
          color: #1f2937;
          transform: rotate(30deg);
      }

      /* Modal Styles */
      .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s ease;
      }

      .modal-overlay.is-visible {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-content {
          background: #fff;
          padding: 1.5rem 2rem;
          border-radius: 12px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          width: 90%;
          max-width: 400px;
          transform: translateY(-20px);
          transition: transform 0.3s ease;
      }

      .modal-overlay.is-visible .modal-content {
        transform: translateY(0);
      }

      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-bottom: 1px solid #e5e7eb;
          padding-bottom: 0.8rem;
          margin-bottom: 1rem;
      }

      .modal-header h2 {
          margin: 0;
          font-size: 1.4rem;
          color: #333;
      }

      .close-button {
          background: none;
          border: none;
          font-size: 2rem;
          font-weight: bold;
          color: #aaa;
          cursor: pointer;
          line-height: 1;
      }
      .close-button:hover {
          color: #333;
      }

      .modal-body {
          margin-bottom: 1.5rem;
      }
      
      .modal-footer {
          display: flex;
          justify-content: flex-end;
          gap: 0.5rem;
      }

      .form-group {
          margin-bottom: 1rem;
      }
      .form-group label {
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 500;
          color: #374151;
      }
      .form-group input {
          width: 100%;
          padding: 0.6rem;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          font-size: 1rem;
          box-sizing: border-box;
      }
      #passwordError {
          color: #ef4444;
          font-size: 0.9rem;
          margin-top: 0.5rem;
          height: 1em;
      }
      
      .settings-grid {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
      }

      #repoFileList {
          max-height: 60vh;
          overflow-y: auto;
      }

      .repo-file-list {
          list-style: none;
          padding: 0;
          margin: 0;
      }

      .repo-file-list li {
          padding: 0.8rem 0.5rem;
          border-bottom: 1px solid #f3f4f6;
          cursor: pointer;
          transition: background-color 0.2s;
          font-size: 1.1rem;
      }

      .repo-file-list li:hover {
          background-color: #f3f4f6;
      }

      .speech-controls-container {
          display: flex;
          justify-content: center;
          align-items: center;
          gap: 0.75rem;
          width: 100%;
          max-width: 400px;
          margin: 0 auto 1rem auto;
      }

      .speak-btn-icon {
          background: #f0f9ff;
          color: #0c4a6e;
          border: 1px solid #7dd3fc;
          border-radius: 50%;
          font-size: 1.5rem;
          cursor: pointer;
          transition: background-color 0.2s, color 0.2s;
          width: 44px;
          height: 44px;
          display: flex;
          justify-content: center;
          align-items: center;
          padding: 0;
          flex-shrink: 0;
      }
      .speak-btn-icon:hover {
          background: #e0f2fe;
          color: #0369a1;
      }

      .speech-controls-container input[type="range"] {
          flex-grow: 1;
          margin: 0;
      }

      .speech-controls-container #speechRateValue {
          font-size: 1rem;
          color: #4b5563;
          min-width: 2.5em;
          text-align: right;
          font-variant-numeric: tabular-nums;
      }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="app"></div>
    <script>
      let dynamicLists = [];
      let currentList = null;
      let currentMode = "learn";
      let progressData = {}; 
      let appSettings = {};
      const app = document.getElementById("app");

      const LISTS_KEY = 'flashcard_lists';
      const PROGRESS_KEY = 'flashcard_progress';
      const SETTINGS_KEY = 'flashcard_settings';

      const defaultSettings = {
        problemNo: 1,
        chapter: 2,
        pointNo: 3,
        cardBack: 4,
        cardFront: 5,
        correctAnswer: 6,
        choice1: 7,
        choice2: 8,
        choice3: 9,
        choice4: 10,
        speechRate: 1.0,
      };

      function saveState() {
          try {
              localStorage.setItem(LISTS_KEY, JSON.stringify(dynamicLists));
              localStorage.setItem(PROGRESS_KEY, JSON.stringify(progressData));
              localStorage.setItem(SETTINGS_KEY, JSON.stringify(appSettings));
          } catch (e) {
              console.error("Failed to save state:", e);
              alert("„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ");
          }
      }

      function loadState() {
          try {
              const savedLists = localStorage.getItem(LISTS_KEY);
              const savedProgress = localStorage.getItem(PROGRESS_KEY);
              const savedSettings = localStorage.getItem(SETTINGS_KEY);
              if (savedLists) {
                  dynamicLists = JSON.parse(savedLists);
              }
              if (savedProgress) {
                  progressData = JSON.parse(savedProgress);
              }
              if (savedSettings) {
                appSettings = { ...defaultSettings, ...JSON.parse(savedSettings) };
              } else {
                appSettings = { ...defaultSettings };
              }
          } catch (e) {
              console.error("Failed to load state:", e);
              localStorage.clear(); // Clear all data on parsing error
          }
      }

      function showHomePage() {
        app.innerHTML = `
          <div class="container">
            <button id="settingsBtn" title="Ë®≠ÂÆö">‚öôÔ∏è</button>
            <h1 class="title">„Ç´„Çπ„Çø„É†Â≠¶Áøí-4Taku_v0</h1>
            <div id="lists"></div>
            <div class="mt-8 text-center">
              <button id="selectFromRepoBtn" class="add-btn" style="margin-bottom: 1rem;">„É™„Çπ„ÉàÈÅ∏Êäû</button>
              <input type="file" id="fileInput" accept=".tsv" style="display:none;">
              <button id="addListBtn" class="add-btn-secondary">„É™„Çπ„ÉàËøΩÂä†</button>
            </div>
          </div>
          <div id="repoModal" class="modal-overlay">
            <div class="modal-content">
              <div class="modal-header">
                <h2>GitHub„Åã„Çâ„É™„Çπ„Éà„ÇíÈÅ∏Êäû</h2>
                <button class="close-button">&times;</button>
              </div>
              <div id="repoFileList">
                <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
              </div>
            </div>
          </div>
          <div id="passwordModal" class="modal-overlay">
             <div class="modal-content">
               <div class="modal-header">
                  <h2>„Éë„Çπ„ÉØ„Éº„ÉâÂÖ•Âäõ</h2>
                  <button class="close-button">&times;</button>
               </div>
               <div class="modal-body">
                  <p>Ë®≠ÂÆö„ÇíÂ§âÊõ¥„Åô„Çã„Å´„ÅØ„Éë„Çπ„ÉØ„Éº„ÉâÔºà4Ê°ÅÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                  <div class="form-group">
                      <label for="passwordInput">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                      <input type="password" id="passwordInput" maxlength="4" inputmode="numeric" pattern="[0-9]*">
                  </div>
                  <div id="passwordError"></div>
               </div>
               <div class="modal-footer">
                   <button id="passwordSubmitBtn" class="mode-btn learn">Á¢∫Ë™ç</button>
               </div>
             </div>
          </div>
          <div id="settingsModal" class="modal-overlay">
             <div class="modal-content">
               <div class="modal-header">
                  <h2>„Ç¢„Éó„É™Ë®≠ÂÆö</h2>
                  <button class="close-button">&times;</button>
               </div>
               <div class="modal-body">
                  <form id="settingsForm">
                    <p>TSV„Éï„Ç°„Ç§„É´„ÅÆÂêÑ„Éá„Éº„Çø„Åå‰ΩïÂàóÁõÆ„Å´„ÅÇ„Çã„Åã„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                    <div class="settings-grid">
                      <div class="form-group">
                        <label for="col-cardFront">„Ç´„Éº„ÉâË°® (ÂïèÈ°å)</label>
                        <input type="number" id="col-cardFront" data-key="cardFront" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-cardBack">„Ç´„Éº„ÉâË£è („Éí„É≥„Éà)</label>
                        <input type="number" id="col-cardBack" data-key="cardBack" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-correctAnswer">Ê≠£Ëß£</label>
                        <input type="number" id="col-correctAnswer" data-key="correctAnswer" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-choice1">ÈÅ∏ÊäûËÇ¢1</label>
                        <input type="number" id="col-choice1" data-key="choice1" min="1">
                      </div>
                       <div class="form-group">
                        <label for="col-choice2">ÈÅ∏ÊäûËÇ¢2</label>
                        <input type="number" id="col-choice2" data-key="choice2" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-choice3">ÈÅ∏ÊäûËÇ¢3</label>
                        <input type="number" id="col-choice3" data-key="choice3" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-choice4">ÈÅ∏ÊäûËÇ¢4</label>
                        <input type="number" id="col-choice4" data-key="choice4" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-problemNo">ÂïèÈ°åNo</label>
                        <input type="number" id="col-problemNo" data-key="problemNo" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-chapter">Chapter</label>
                        <input type="number" id="col-chapter" data-key="chapter" min="1">
                      </div>
                      <div class="form-group">
                        <label for="col-pointNo">PointNo</label>
                        <input type="number" id="col-pointNo" data-key="pointNo" min="1">
                      </div>
                    </div>
                  </form>
               </div>
               <div class="modal-footer">
                   <button id="saveSettingsBtn" class="mode-btn learn">‰øùÂ≠ò</button>
                   <button id="resetSettingsBtn" class="sub-btn">„É™„Çª„ÉÉ„Éà</button>
               </div>
             </div>
          </div>
        `;
        
        const listsDiv = document.getElementById("lists");

        if (dynamicLists.length === 0) {
            listsDiv.innerHTML = '<p style="text-align: center; color: #6b7280;">„É™„Çπ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>';
        } else {
            const listsHtml = dynamicLists.map(list => {
                const listId = list.id;
                const progress = progressData[listId];
                let progressHtml = '';
                let modeIndicator = '';

                if (progress) {
                    const remaining = progress.remaining.length;
                    const perfect = progress.perfect.length;
                    const again = progress.again.length;
                    progressHtml = `<div class="progress-info">„ÅÆ„Åì„Çä${remaining}Êûö / Ê≠£Ëß£${perfect}Êûö / ‰∏çÊ≠£Ëß£${again}Êûö</div>`;
                    
                    const modeText = progress.mode === 'learn' ? 'Â≠¶Áøí' : '„ÉÜ„Çπ„Éà';
                    modeIndicator = ` <span style="font-weight: normal; font-size: 0.9rem; color: #4b5563;">Ôºà${modeText}Ôºâ</span>`;
                }
                
                const cleanListName = list.name.replace(/\.[^/.]+$/, "");
                const displayName = `${cleanListName}${modeIndicator}`;
                const learnButtonText = 'Â≠¶Áøí„É¢„Éº„Éâ';
                const testButtonText = '4Êäû„ÉÜ„Çπ„Éà';


                return `
                <div class="list-card">
                  <div class="list-header">
                    <h2 class="list-title" title="${list.name}">${displayName}</h2>
                    <button class="delete-btn" data-id="${listId}">ÂâäÈô§</button>
                  </div>
                  ${progressHtml}
                  <div class="list-btns">
                    <button class="mode-btn learn" data-id="${listId}" data-mode="learn">${learnButtonText}</button>
                    <button class="mode-btn test" data-id="${listId}" data-mode="test">${testButtonText}</button>
                  </div>
                </div>
              `;
            }).join("");
            listsDiv.innerHTML = listsHtml;
        }

        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.onclick = () => {
            const listId = parseInt(btn.dataset.id, 10);
            currentList = dynamicLists.find(l => l.id === listId);
            currentMode = btn.dataset.mode;
            const progress = progressData[listId];
            if (progress && progress.mode === currentMode) {
              if (confirm("‰∏≠Êñ≠„Åó„Åü„Çª„ÉÉ„Ç∑„Éß„É≥„ÇíÂÜçÈñã„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Äå„Ç≠„É£„É≥„Çª„É´„Äç„ÅßÊúÄÂàù„Åã„ÇâÂßã„ÇÅ„Åæ„ÅôÔºâ")) {
                showFlashcardPage(progress);
                return;
              } else {
                delete progressData[listId];
                saveState();
              }
            }
            showFlashcardPage();
          };
        });
        
        document.querySelectorAll(".delete-btn").forEach((btn) => {
            btn.onclick = (e) => {
                e.stopPropagation();
                const listId = parseInt(btn.dataset.id, 10);
                const listToDelete = dynamicLists.find(list => list.id === listId);
                const cleanListName = listToDelete.name.replace(/\.[^/.]+$/, "");
                if (listToDelete && confirm(`„Äå${cleanListName}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„ÇãÈÄ≤Êçó„ÇÇÂ§±„Çè„Çå„Åæ„Åô„ÄÇ`)) {
                    dynamicLists = dynamicLists.filter(list => list.id !== listId);
                    delete progressData[listId];
                    saveState();
                    showHomePage();
                }
            };
        });
        
        document.getElementById("settingsBtn").onclick = openPasswordModal;
        document.getElementById("selectFromRepoBtn").onclick = openRepoModal;
        document.getElementById("addListBtn").onclick = () => document.getElementById("fileInput").click();
        document.getElementById("fileInput").onchange = async (e) => {
          const target = e.target;
          const file = target.files?.[0];
          if (!file) return;
          const text = await file.text();
          const words = parseTsv(text);
          if (words.length > 0) {
            dynamicLists.push({ id: Date.now(), name: file.name, words });
            saveState();
            showHomePage();
          } else {
            alert("„Éï„Ç°„Ç§„É´„ÅåÁ©∫„Åã„ÄÅÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nË®≠ÂÆö„Åï„Çå„ÅüÂàóÁï™Âè∑„Åå„Éï„Ç°„Ç§„É´„ÅÆÂàóÊï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
          }
          target.value = "";
        };
      }

      function parseTsv(text) {
        const s = appSettings;
        const requiredCols = [s.cardFront, s.cardBack, s.correctAnswer, s.choice1, s.choice2, s.choice3, s.choice4];
        const maxCol = Math.max(...requiredCols);

        return text.trim().split(/\r?\n/).map((line) => {
            const parts = line.split("\t");
            if (parts.length < maxCol) return null;

            // 1-based index to 0-based
            const getPart = (col) => parts[col - 1]?.trim() || '';

            const english = getPart(s.cardFront);
            const japanese = getPart(s.cardBack);
            const correctAnswer = getPart(s.correctAnswer);
            const choices = [
                getPart(s.choice1),
                getPart(s.choice2),
                getPart(s.choice3),
                getPart(s.choice4),
            ];
            
            const problemNo = getPart(s.problemNo);
            const chapter = getPart(s.chapter);
            const pointNo = getPart(s.pointNo);
            const number = `${problemNo}-${chapter}-${pointNo}`;

            if (english && japanese && correctAnswer && choices.every(ch => ch)) {
                return { number, english, japanese, correctAnswer, choices };
            }
            return null;
        }).filter(word => word !== null);
      }
      
      function openRepoModal() {
        const modal = document.getElementById('repoModal');
        modal.classList.add('is-visible');
        modal.querySelector('.close-button').onclick = () => modal.classList.remove('is-visible');
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.classList.remove('is-visible');
          }
        };

        const fileListDiv = document.getElementById('repoFileList');
        fileListDiv.innerHTML = '<p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>';

        fetch('./manifest.json')
          .then(response => {
            if (!response.ok) {
              throw new Error('manifest.json„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
            return response.json();
          })
          .then(data => {
            if (!data.files || data.files.length === 0) {
              fileListDiv.innerHTML = '<p>Âà©Áî®ÂèØËÉΩ„Å™„Éï„Ç°„Ç§„É´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
              return;
            }
            const ul = document.createElement('ul');
            ul.className = 'repo-file-list';
            data.files.forEach(filename => {
              const li = document.createElement('li');
              li.textContent = filename.replace(/\.[^/.]+$/, "");
              li.onclick = () => loadFileFromRepo(filename);
              ul.appendChild(li);
            });
            fileListDiv.innerHTML = '';
            fileListDiv.appendChild(ul);
          })
          .catch(error => {
            console.error('Error loading manifest:', error);
            fileListDiv.innerHTML = `<p style="color: red;">„Ç®„É©„Éº: ${error.message}</p><p style="font-size: 0.8em;">„É™„Éù„Ç∏„Éà„É™„ÅÆ„É´„Éº„Éà„Å´data/manifest.json„ÇíË®≠ÁΩÆ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>`;
          });
      }

      async function loadFileFromRepo(filename) {
        try {
          const response = await fetch(`./${filename}`);
          if (!response.ok) {
            throw new Error(`„Éï„Ç°„Ç§„É´'${filename}'„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ`);
          }
          const text = await response.text();
          const words = parseTsv(text);
          if (words.length > 0) {
            dynamicLists.push({ id: Date.now(), name: filename, words });
            saveState();
            document.getElementById('repoModal').classList.remove('is-visible');
            showHomePage();
          } else {
            alert("„Éï„Ç°„Ç§„É´„ÅåÁ©∫„Åã„ÄÅÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ\nË®≠ÂÆö„Åï„Çå„ÅüÂàóÁï™Âè∑„Åå„Éï„Ç°„Ç§„É´„ÅÆÂàóÊï∞„ÇíË∂Ö„Åà„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ");
          }
        } catch (error) {
          console.error('Error loading file from repo:', error);
          alert(`„Ç®„É©„Éº: ${error.message}`);
        }
      }

      function openPasswordModal() {
        const modal = document.getElementById('passwordModal');
        modal.classList.add('is-visible');
        const passwordInput = document.getElementById('passwordInput');
        passwordInput.value = '';
        passwordInput.focus();
        document.getElementById('passwordError').textContent = '';

        modal.querySelector('.close-button').onclick = () => modal.classList.remove('is-visible');
        document.getElementById('passwordSubmitBtn').onclick = checkPassword;
        passwordInput.onkeydown = (e) => {
          if (e.key === 'Enter') {
            checkPassword();
          }
        };
      }

      function checkPassword() {
        const passwordInput = document.getElementById('passwordInput');
        const errorDiv = document.getElementById('passwordError');
        if (passwordInput.value === '1234') { // Simple hardcoded password
          document.getElementById('passwordModal').classList.remove('is-visible');
          openSettingsModal();
        } else {
          errorDiv.textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÈÅï„ÅÑ„Åæ„Åô„ÄÇ';
          passwordInput.value = '';
        }
      }
      
      function openSettingsModal() {
        const modal = document.getElementById('settingsModal');
        modal.classList.add('is-visible');
        const form = document.getElementById('settingsForm');

        form.querySelectorAll('input').forEach(input => {
            if (appSettings[input.dataset.key] !== undefined) {
              input.value = appSettings[input.dataset.key];
            }
        });

        modal.querySelector('.close-button').onclick = () => modal.classList.remove('is-visible');
        document.getElementById('saveSettingsBtn').onclick = saveSettings;
        document.getElementById('resetSettingsBtn').onclick = () => {
            if (confirm('Ë®≠ÂÆö„ÇíÂàùÊúüÂÄ§„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü')) {
                appSettings = { ...defaultSettings };
                 form.querySelectorAll('input').forEach(input => {
                    const key = input.dataset.key;
                    if (appSettings[key] !== undefined) {
                      input.value = appSettings[key];
                    }
                });
            }
        };
      }
      
      function saveSettings() {
        const form = document.getElementById('settingsForm');
        let isValid = true;
        form.querySelectorAll('input').forEach(input => {
          const key = input.dataset.key;
          if (input.type === 'number') {
            const value = parseInt(input.value, 10);
            if (isNaN(value) || value < 1) {
              isValid = false;
            }
            appSettings[key] = value;
          } else if (input.type === 'range') {
            const value = parseFloat(input.value);
            appSettings[key] = value;
          }
        });

        if (!isValid) {
            alert('„Åô„Åπ„Å¶„ÅÆÂàóË®≠ÂÆöÈ†ÖÁõÆ„Å´1‰ª•‰∏ä„ÅÆÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }

        saveState();
        document.getElementById('settingsModal').classList.remove('is-visible');
        alert('Ë®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
      }

      function showFlashcardPage(resumeState = null) {
        if (!currentList || !currentList.words[0]?.choices) {
          alert("„Åì„ÅÆ„É™„Çπ„Éà„ÅØ4Êäû„ÇØ„Ç§„Ç∫ÂΩ¢Âºè„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
          showHomePage();
          return;
        }

        let words, idx, checked, unchecked;
        let isFlipped = false;
        let isAnswered = false;

        if (resumeState) {
            words = resumeState.remaining;
            idx = 0;
            checked = resumeState.perfect;
            unchecked = resumeState.again;
        } else {
            words = currentMode === 'learn' 
                ? [...currentList.words] 
                : shuffle([...currentList.words]);
            idx = 0;
            checked = [];
            unchecked = [];
        }
        
        function suspendSession() {
          if (idx >= words.length) { 
            delete progressData[currentList.id];
          } else {
            progressData[currentList.id] = {
              remaining: words.slice(idx),
              perfect: checked,
              again: unchecked,
              mode: currentMode,
            };
          }
          saveState();
          showHomePage();
        }
        
        function resetCurrentList() {
            delete progressData[currentList.id];
            saveState();
            showFlashcardPage();
        }
        
        function startReview() {
          if (unchecked.length === 0) {
            alert("‰∏çÊ≠£Ëß£„ÅÆ„Ç´„Éº„Éâ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ");
            return;
          }
          words = shuffle([...unchecked]);
          idx = 0;
          checked = [];
          unchecked = [];
          isFlipped = false;
          isAnswered = false;
          render();
        }

        function handleChoiceClick() {
          if (isAnswered) return;
          isAnswered = true;
          
          const word = words[idx];
          const isCorrect = cleanChoiceText(word.selectedAnswer) === cleanChoiceText(word.correctAnswer);

          if (isCorrect) {
            checked.push(word);
          } else {
            unchecked.push(word);
          }
          render();
        }
        
        function goToNextQuestion() {
            idx++;
            isAnswered = false;
            isFlipped = false;
            render();
        }

        function render() {
          if (idx >= words.length) {
            delete progressData[currentList.id]; 
            saveState();
            const cleanListName = currentList?.name.replace(/\.[^/.]+$/, "");
            app.innerHTML = `
              <div class="container flashcard-page">
                <h2 class="flashcard-page-title">${cleanListName}</h2>
                <div class="card-container">
                  <div class="card done-card">
                    <div class="card-face card-front">üéâ ÂÆå‰∫ÜÔºÅ</div>
                  </div>
                </div>
                <div class="counters">
                  <span>„ÅÆ„Åì„Çä: 0</span>
                  <span>Ê≠£Ëß£: ${checked.length}</span>
                  <span>‰∏çÊ≠£Ëß£: ${unchecked.length}</span>
                </div>
                <div class="sub-btn-row">
                  <button id="resetBtn" class="sub-btn sub-btn-reset">„É™„Çª„ÉÉ„Éà</button>
                  <button id="reviewBtn" class="sub-btn sub-btn-review">„Äå‰∏çÊ≠£Ëß£„Äç„ÇíÂæ©Áøí</button>
                </div>
                <div class="mt-8">
                  <button id="backBtn" class="back-link">¬´ „É™„Çπ„ÉàÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã</button>
                </div>
              </div>
            `;
            document.getElementById("resetBtn").onclick = resetCurrentList;
            document.getElementById("reviewBtn").onclick = startReview;
            document.getElementById("backBtn").onclick = showHomePage;
            return;
          }

          const word = words[idx];
          const cleanListName = currentList?.name.replace(/\.[^/.]+$/, "");
          const modeTitle = currentMode === 'learn' ? 'Â≠¶Áøí' : '„ÉÜ„Çπ„Éà';
          
          let actionButtonsHtml = '';
          if (isAnswered) {
             actionButtonsHtml = `<button id="nextBtn" class="next-btn">Ê¨°„Å∏</button>`;
          } else {
             actionButtonsHtml = `
                <div class="sub-btn-row">
                  <button id="suspendBtn" class="sub-btn sub-btn-suspend">‰∏≠Êñ≠</button>
                  <button id="resetBtn" class="sub-btn sub-btn-reset">„É™„Çª„ÉÉ„Éà</button>
                  <button id="reviewBtn" class="sub-btn sub-btn-review">„Äå‰∏çÊ≠£Ëß£„Äç„ÇíÂæ©Áøí</button>
                </div>
             `;
          }

          const choicesHtml = word.choices.map(choice => {
              let btnClass = 'choice-btn';
              if (isAnswered) {
                  const cleanedChoice = cleanChoiceText(choice);
                  const cleanedCorrectAnswer = cleanChoiceText(word.correctAnswer);
                  
                  const isCorrectChoice = cleanedChoice === cleanedCorrectAnswer;
                  const isSelectedChoice = choice === word.selectedAnswer;

                  if (currentMode === 'learn') {
                      if (isCorrectChoice) {
                          btnClass += ' correct';
                      } else {
                          btnClass += ' incorrect';
                      }
                  } else { // test mode
                      if (isSelectedChoice) {
                          if (isCorrectChoice) {
                              btnClass += ' correct';
                          } else {
                              btnClass += ' incorrect';
                          }
                      }
                  }
              }
              const disabled = isAnswered ? 'disabled' : '';
              return `<button class="${btnClass}" data-choice="${choice}" ${disabled}>${choice}</button>`;
          }).join('');


          app.innerHTML = `
            <div class="container flashcard-page">
              <h2 class="flashcard-page-title">${cleanListName} <span>(${modeTitle})</span></h2>
              <div class="problem-number">${word.number}</div>
              <div class="card-container" id="card-flipper">
                <div class="card${isFlipped ? " is-flipped" : ""}">
                  <div class="card-face card-front">
                    ${word.english}
                  </div>
                  <div class="card-face card-back">
                    ${word.japanese}
                  </div>
                </div>
              </div>

              <div class="speech-controls-container">
                <button id="speakBtn" class="speak-btn-icon" title="Áô∫Èü≥„ÇíËÅû„Åè">üîä</button>
                <input type="range" id="speechRateSlider" min="0.5" max="2" step="0.1" value="${appSettings.speechRate}">
                <span id="speechRateValue">${parseFloat(appSettings.speechRate).toFixed(1)}</span>
              </div>
              
              <div class="choices-container">
                ${choicesHtml}
              </div>

              <div class="counters">
                <span>„ÅÆ„Åì„Çä: ${words.length - idx}</span>
                <span>Ê≠£Ëß£: ${checked.length}</span>
                <span>‰∏çÊ≠£Ëß£: ${unchecked.length}</span>
              </div>

              <div class="action-buttons-container">
                ${actionButtonsHtml}
              </div>

              <div class="mt-8">
                <button id="backBtn" class="back-link">¬´ „É™„Çπ„ÉàÈÅ∏Êäû„Å´„ÇÇ„Å©„Çã (‰øùÂ≠ò„Åï„Çå„Åæ„Åõ„Çì)</button>
              </div>
            </div>
          `;
          
          document.getElementById("card-flipper").onclick = (e) => {
              isFlipped = !isFlipped;
              e.currentTarget.querySelector('.card').classList.toggle('is-flipped');
          };

          document.getElementById("speakBtn").onclick = () => {
            speakText(word.english);
          };

          const speechRateSlider = document.getElementById('speechRateSlider');
          const speechRateValueSpan = document.getElementById('speechRateValue');
          speechRateSlider.oninput = () => {
              const newRate = parseFloat(speechRateSlider.value);
              appSettings.speechRate = newRate;
              speechRateValueSpan.textContent = newRate.toFixed(1);
              saveState(); // Save settings immediately
          };
          
          if (isAnswered) {
            document.getElementById("nextBtn").onclick = goToNextQuestion;
          } else {
            document.querySelectorAll(".choice-btn").forEach(btn => {
              btn.onclick = (e) => {
                  words[idx].selectedAnswer = e.currentTarget.dataset.choice;
                  handleChoiceClick();
              };
            });
            document.getElementById("suspendBtn").onclick = suspendSession;
            document.getElementById("resetBtn").onclick = resetCurrentList;
            document.getElementById("reviewBtn").onclick = startReview;
          }
          
          document.getElementById("backBtn").onclick = showHomePage;
        }

        render();
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      
      function cleanChoiceText(text) {
        if (typeof text !== 'string') return '';
        return text.replace(/^\s*\d+\.\s*/, '').trim();
      }
      
      function speakText(textToSpeak, rateOverride = null) {
        if (!('speechSynthesis' in window)) {
          alert('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÈü≥Â£∞Ë™≠„Åø‰∏ä„Åí„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
          return;
        }

        if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
        }
        
        const utterance = new SpeechSynthesisUtterance(textToSpeak);
        utterance.lang = 'en-US';
        utterance.rate = rateOverride !== null ? rateOverride : (appSettings.speechRate || 1.0);
        
        const voices = window.speechSynthesis.getVoices();
        const usVoice = voices.find(voice => voice.lang === 'en-US');
        if (usVoice) {
          utterance.voice = usVoice;
        }
        
        window.speechSynthesis.speak(utterance);
      }

      function initializeApp() {
          loadState();
          showHomePage();
      }

      initializeApp();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
